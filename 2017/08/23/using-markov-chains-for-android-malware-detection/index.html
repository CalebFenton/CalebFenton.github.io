<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Using Markov Chains for Android Malware Detection | Caleb Fenton&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="If you’re chatting with someone, and they tell you “aslkjeklvm,e,zk3l1” then they’re speaking gibberish. But how can you teach a computer to recognize gibberish, and more importantly, why bother? I’ve">
<meta property="og:type" content="article">
<meta property="og:title" content="Using Markov Chains for Android Malware Detection">
<meta property="og:url" content="https://calebfenton.github.io/2017/08/23/using-markov-chains-for-android-malware-detection/index.html">
<meta property="og:site_name" content="Caleb Fenton&#39;s Blog">
<meta property="og:description" content="If you’re chatting with someone, and they tell you “aslkjeklvm,e,zk3l1” then they’re speaking gibberish. But how can you teach a computer to recognize gibberish, and more importantly, why bother? I’ve">
<meta property="og:locale">
<meta property="og:image" content="https://calebfenton.github.io/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_stringLiterals.png">
<meta property="og:image" content="https://calebfenton.github.io/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_stringLiterals.png">
<meta property="article:published_time" content="2017-08-23T05:13:37.000Z">
<meta property="article:modified_time" content="2017-10-29T00:33:06.000Z">
<meta property="article:author" content="Caleb Fenton">
<meta property="article:tag" content="research">
<meta property="article:tag" content="android">
<meta property="article:tag" content="machine learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://calebfenton.github.io/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_stringLiterals.png">
<meta name="twitter:creator" content="@CalebFenton">
  
    <link rel="alternative" href="/rss2.xml" title="Caleb Fenton&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74177443-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Caleb Fenton&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/rss2.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://CalebFenton.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-using-markov-chains-for-android-malware-detection" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/23/using-markov-chains-for-android-malware-detection/" class="article-date">
  <time datetime="2017-08-23T05:13:37.000Z" itemprop="datePublished">2017-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Using Markov Chains for Android Malware Detection
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you’re chatting with someone, and they tell you “aslkjeklvm,e,zk3l1” then they’re speaking gibberish. But how can you teach a computer to recognize gibberish, and more importantly, why bother? I’ve looked at a lot of Android malware, and I’ve noticed that many of them have gibberish strings either as literals in the code, as class names, in the signature, and so on. My hypothesis was that if you could quantify gibberishness, it would be a good feature in a machine learning model. I’ve tested this intuition, and in this post I’ll be sharing my results.</p>
<span id="more"></span>

<h2 id="What-is-a-Markov-chain"><a href="#What-is-a-Markov-chain" class="headerlink" title="What is a Markov chain?"></a>What is a Markov chain?</h2><p>You could just <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Markov_chain">read Wikipedia</a>, but ain’t no one got time for that. Simply put, you show it lots of strings to train it. Once it’s trained, you can give it a string and it’ll tell you how much it looks like the strings it was trained on. This is called getting the probability of a string.</p>
<p>Markov chains are quite simple. The code I used is here: <a target="_blank" rel="noopener" href="https://gist.github.com/CalebFenton/a129333dabc1cc346b0874407f92b568">https://gist.github.com/CalebFenton/a129333dabc1cc346b0874407f92b568</a></p>
<p>It’s loosely based on Rob Neuhaus’s <a target="_blank" rel="noopener" href="https://github.com/rrenaud/Gibberish-Detector">Gibberish Detector</a>.</p>
<h2 id="The-Experiment"><a href="#The-Experiment" class="headerlink" title="The Experiment"></a>The Experiment</h2><p>I’ve been trying to improve the model I use in the <a target="_blank" rel="noopener" href="http://judge.rednaga.io/">Judge</a> Android malware detector. It would have been a lot easier to just create some Markov based features, throw them into the model, and roll with it. But I wanted to be scientific. Everyone thinks science is all fun and rainbows, but thats only in the highlight reel. The real bulk of science, the behind the scenes footage, is tedious and hard. In order to make a data-driven decision about which features worked best and if they helped at all, I took lots of notes of my experiment and preserved all the data. Hopefully, it’s helpful to others.</p>
<p>I started by collecting all of the strings from my data set.  For reference, the data set contained ~185,000 samples, about half of which are malicious. Malicious apps are from all over, but many are from VirusTotal with 20+ positives. Benign apps are possibly more diverse and contain strings in several languages.</p>
<p>After collecting strings, I trained a Markov model on the strings in the benign apps. For each occurrence of a string, I trained the model on that string. This model would “know” what legitimate, non-malicious strings were probable. Then, I calculated the probability of each benign string and plotted the distribution on a curve.</p>
<p>Finally, I used the Markov model trained on the benign strings to calculate probabilities of all the malicious strings and also plotted them. Before I spent time writing any code for features, I wanted to know if there was even a significant difference in probability distribution. If there wasn’t, I would have probably written the code anyway because this is how I spend my weekends, but it turns out there <em>was</em> a significant difference and I felt much more confident the features would be useful.</p>
<p>The Markov chain was configured to use bigrams and strings were tokenized depending on their category. Below are the patterns used:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getTokenSplitPattern</span><span class="params">(String stringType)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (stringType) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;activityNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;receiverNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;serviceNames&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;appLabels&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;appNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;stringLiterals&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;(?:[\\s+\\p&#123;Punct&#125;]+)&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;classNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;fieldNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;methodNames&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;packageNames&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;(?:\\.)&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;packagePaths&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;(?:/)&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerCommonNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerCountryNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerLocalities&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerOrganizationalUnits&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerOrganizations&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;issuerStateNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectCommonNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectCountryNames&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectLocalities&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectOrganizationalUnits&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectOrganizations&quot;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;subjectStateNames&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;(?:\\s+)&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>String categories and the probability distributions are listed below.</p>
<p>From the Android manifest:</p>
<ul>
<li>activityNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_activityNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_activityNames.png">malicious</a></li>
<li>appLabels - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_appLabels.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_appLabels.png">malicious</a></li>
<li>appNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_appNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_appNames.png">malicious</a></li>
<li>packageNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_packageNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_packageNames.png">malicious</a></li>
<li>receiverNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_receiverNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_receiverNames.png">malicious</a></li>
<li>serviceNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_serviceNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_serviceNames.png">malicious</a></li>
</ul>
<p>From the Dalvik executable code:</p>
<ul>
<li>classNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_classNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_classNames.png">malicious</a></li>
<li>fieldNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_fieldNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_fieldNames.png">malicious</a></li>
<li>methodNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_methodNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_methodNames.png">malicious</a></li>
<li>packagePaths - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_packagePaths.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_packagePaths.png">malicious</a></li>
<li>stringLiterals - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_stringLiterals.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_stringLiterals.png">malicious</a></li>
</ul>
<p>From the signing certificate:</p>
<ul>
<li>issuerCommonNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerCommonNames.png">benign</a> &#x2F;  <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerCommonNames.png">malicious</a></li>
<li>issuerCountryNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerCountryNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerCountryNames.png">malicious</a></li>
<li>issuerLocalities - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerLocalities.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerLocalities.png">malicious</a></li>
<li>issuerOrganizationalUnits - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerOrganizationalUnits.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerOrganizationalUnits.png">malicious</a></li>
<li>issuerOrganizations - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerOrganizations.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerOrganizations.png">malicious</a></li>
<li>issuerStateNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_issuerStateNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_issuerStateNames.png">malicious</a></li>
<li>subjectCommonNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectCommonNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectCommonNames.png">malicious</a></li>
<li>subjectCountryNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectCountryNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectCountryNames.png">malicious</a></li>
<li>subjectLocalities - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectLocalities.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectLocalities.png">malicious</a></li>
<li>subjectOrganizationalUnits - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectOrganizationalUnits.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectOrganizationalUnits.png">malicious</a></li>
<li>subjectOrganizations - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectOrganizations.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectOrganizations.png">malicious</a></li>
<li>subjectStateNames - <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_subjectStateNames.png">benign</a> &#x2F; <a href="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_subjectStateNames.png">malicious</a></li>
</ul>
<h2 id="Comparing-the-Graphs"><a href="#Comparing-the-Graphs" class="headerlink" title="Comparing the Graphs"></a>Comparing the Graphs</h2><p>Let’s look at a specific example. One of the largest collections of strings were the string literals. These were all the strings that occurred in code. So in the case of <code>String message = &quot;hello,world!&quot;;</code>, the string literal is <code>hello,world!</code>.</p>
<p>Below is the probability distribution of benign strings:</p>
<p><img src="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_benign_stringLiterals.png" alt="benign string literals"></p>
<p>Below is the probability distribution of <em>malicious</em> strings:</p>
<p><img src="/images/using-markov-chains-for-android-malware-detection/markov_probabilities_malicious_stringLiterals.png" alt="malicious string literals"></p>
<p>Notice the scale along the x-axis is different between the two graphs, but also note this isn’t as important as the general shape.</p>
<p>In the benign graph, strings are generally of a higher probability, <em>especially</em> at the lower end between <code>0.01</code> and <code>0.05</code> probability. This would indicate that adding this information to the model would improve model performance.</p>
<p>To add this information as a feature, I collected the probabilities of each string and put them into different bins. For example, for every string with a probability &lt;&#x3D; <code>0.01</code>, I incremented the count of strings in the “probability 0.01” bin. The bins were:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span>[] bins = <span class="keyword">new</span> <span class="title class_">double</span>[]&#123;</span><br><span class="line">    <span class="number">0.01</span>, <span class="number">0.02</span>, <span class="number">0.03</span>, <span class="number">0.04</span>, <span class="number">0.05</span>, <span class="number">0.06</span>, <span class="number">0.08</span>, <span class="number">0.10</span>,</span><br><span class="line">    <span class="number">0.20</span>, <span class="number">0.30</span>, <span class="number">0.40</span>, <span class="number">0.50</span>, <span class="number">1.0</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Notice that bins were more numerous in the lower probabilities to better capture the difference in observed distribution between the two classes (malicious &#x2F; benign). Similar bin distributions were made for other string categories.</p>
<h2 id="Results-and-Conclusion"><a href="#Results-and-Conclusion" class="headerlink" title="Results and Conclusion"></a>Results and Conclusion</h2><p>By incorporating Markov features, model performance was fairly improved. Below are the “v1” model scores from a 10-fold cross validation using the top 10,000 features:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recall: 0.938063119746</span><br><span class="line">precision: 0.979244936027</span><br><span class="line">accuracy: 0.965148875727</span><br></pre></td></tr></table></figure>

<p>Below are the “v2” model scores measured in the same way:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recall: 0.958403081067</span><br><span class="line">precision: 0.984061094076</span><br><span class="line">accuracy: 0.97440419396</span><br></pre></td></tr></table></figure>

<p>I regard this as pretty good because every percentage point over 90% is difficult. Also note that these model performance scores are not using the optimal algorithm. I just threw the top 10,000 features into an <a target="_blank" rel="noopener" href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.ExtraTreesClassifier.html">ExtraTreesClassifier</a> because it’s fast and fairly good. I wasn’t interested in best possible score, only relative improvements. Using a single, well-tuned model, and smarter feature selection, performance reaches 99%.</p>
<p>But 99% is still relatively poor performance for anti-virus, especially for precision, because false positives are so bad. I think the reason for the poor performance is because the malicious test set included adware and injected malware. Adware apps are difficult to distinguish statically and it’s even hard with skilled, manual analysis. Usually, it can only be known by behavioral analysis, i.e. does running this app cause many “annoying” ads to be displayed. By focusing the data set (i.e. cherry picking) more overtly malicious apps, model performance may get a lot better.</p>
<p>So-called injected malware is an otherwise benign app which has had malicious code injected into it. This is uniquely easy for Android malware authors due to the ease of app disassembly and reassembly. Perhaps unsurprisingly, the top features in Judge’s model are from <a target="_blank" rel="noopener" href="https://github.com/rednaga/APKiD">APKiD</a> which can <a target="_blank" rel="noopener" href="https://rednaga.io/2016/07/31/detecting_pirated_and_malicious_android_apps_with_apkid/">fingerprint the compiler as a proxy for if an app has had code injected into it</a>. This type of malware is also difficult to detect because usually most of the code is legitimate and this means features will reflect a <em>mostly</em> legitimate app.</p>
<p>In any case, further experimentation need to be done to decide which class of malware is most often missed. Once this is known, more features should be added to specifically address that type of malware.</p>
<p>Another remediating factor to consider with using this model is that any real anti-virus solution will be able to generally white list several types of apps to greatly reduce the impact of false positives. For example, an anti-virus company could record which signatures are most common and whitelist all of them. This would preclude the possibility of false positive detections of any popular or system apps.</p>
<h2 id="Future-Work"><a href="#Future-Work" class="headerlink" title="Future Work"></a>Future Work</h2><p>This experiment took two days to run and most of the time was spent extracting features. Also, during that time, my main desktop was booted into Linux and was unavailable for gaming, which was a huge drag. It should be possible to use a smaller data set to reduce iteration time. Maybe I could try 20-50 thousand rather than 180 thousand. samples.</p>
<p>Markov tokenization and n-gram selection can also be adjusted. It’s not clear if bigrams are ideal here. Trigrams may be better, or maybe 1-grams. Maybe it would be better to tokenize string literals only on spaces rather than spacing and punctuation since a lot of obfuscated strings are heavy on punctuation, and it would be good to capture that.</p>
<p>Learning done on the Markov features is probably quite sensitive to how the bins are defined. It may be good to add more bins in the upper ranges, or perhaps even more bins in the lower ranges. Once there are a few data points for performance, it should be possible to algorithmically determine bin sizes and automate some of the guess work. This would make ongoing model updates easier.</p>
<p>It may be useful to filter out commonly occurring classes. Most apps are bloated with common libraries, and by filtering them, the features would more accurately reflect what’s unique to each app. I’ve already created the fingerprinting code, which I’ll write about in a later post. My concern with this is that it’ll require more work to maintain a list of common classes since major libraries are numerous and change frequently.</p>
<h2 id="Reference-Data"><a href="#Reference-Data" class="headerlink" title="Reference Data"></a>Reference Data</h2><p>I’m a big believer in sharing data so people can play with it themselves. Below are links to most of the data for these experiments:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mega.nz/#!rdFXHajZ!bLoXZhZ48-54qYqSNl408KB9hRresmfGTIbVbo0vW4A">Benign string counts</a></li>
<li><a target="_blank" rel="noopener" href="https://mega.nz/#!WQFThLKb!0jh4sTpuHB0LXUFCWqNNArL8uEZ59LaeJvcwN1c7Bqo">Malicious string counts</a></li>
<li><a target="_blank" rel="noopener" href="https://mega.nz/#!zZl20S6Y!ENjjbriwnslkbv1EDTxBesrhARUads2RZIitSTrLgdQ">Serialized Markov model</a></li>
</ul>
<p>These are compressed JSON files which should be easy to inspect and understand. String counts were recorded rather than strings because the Markov chains were trained by adding each string to the chain for each time it was counted. So if a string was seen 100 times, the Markov chain would have that string added 100 times.</p>
<p>Here’s some example code to deserialize the Markov model. This assumes it’s part of the Jar as a resource.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> MarkovLoader.class.getResourceAsStream(<span class="string">&quot;/markov_chains.obj&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (is == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Markov chains resource not found&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(is);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">Map&lt;String, MarkovChain&gt; markovChains;</span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> HashMap) &#123;</span><br><span class="line">    markovChains = (HashMap) obj;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Weird markov chain resource&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://calebfenton.github.io/2017/08/23/using-markov-chains-for-android-malware-detection/" data-id="ckzxb6f7u000zhfao4k1jbhmu" class="article-share-link">Share</a>
      
        <a href="https://calebfenton.github.io/2017/08/23/using-markov-chains-for-android-malware-detection/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/machine-learning/" rel="tag">machine learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/research/" rel="tag">research</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/09/24/malware-analysts-guide-to-bitcoin/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Malware Analyst’s Guide to Bitcoin
        
      </div>
    </a>
  
  
    <a href="/2017/05/27/monitoring-https-of-a-single-app-on-osx/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Monitoring HTTPS Traffic of a Single App on OSX</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/28/measuring-the-usefulness-of-multiple-models/">Measuring the Usefulness of Multiple Models</a>
          </li>
        
          <li>
            <a href="/2017/09/25/filtering-popular-code-and-effects-on-model-accuracy/">Filtering Popular Code and Effects on Model Accuracy</a>
          </li>
        
          <li>
            <a href="/2017/09/24/malware-analysts-guide-to-bitcoin/">Malware Analyst’s Guide to Bitcoin</a>
          </li>
        
          <li>
            <a href="/2017/08/23/using-markov-chains-for-android-malware-detection/">Using Markov Chains for Android Malware Detection</a>
          </li>
        
          <li>
            <a href="/2017/05/27/monitoring-https-of-a-single-app-on-osx/">Monitoring HTTPS Traffic of a Single App on OSX</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div id="twitter-feed" class="widget-wrap">
  <h3 class="widget-title">Twitter Feed</h3>
  <div class="widget">
    <a class="twitter-timeline" data-height="2000" target="_blank" rel="noopener" href="https://twitter.com/caleb_fenton">Tweets by caleb_fenton</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anti-virus/" rel="tag">anti-virus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bitcoin/" rel="tag">bitcoin</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/business/" rel="tag">business</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-kata/" rel="tag">code-kata</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/culture/" rel="tag">culture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dalvik/" rel="tag">dalvik</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deobfuscation/" rel="tag">deobfuscation</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dex-oracle/" rel="tag">dex-oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jni/" rel="tag">jni</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machine-learning/" rel="tag">machine learning</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/networking/" rel="tag">networking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/" rel="tag">open source</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/realtalk/" rel="tag">realtalk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/research/" rel="tag">research</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reversing/" rel="tag">reversing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simplify/" rel="tag">simplify</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smali/" rel="tag">smali</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smalivm/" rel="tag">smalivm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tdd/" rel="tag">tdd</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/anti-virus/" style="font-size: 10px;">anti-virus</a> <a href="/tags/bitcoin/" style="font-size: 12px;">bitcoin</a> <a href="/tags/business/" style="font-size: 10px;">business</a> <a href="/tags/code-kata/" style="font-size: 12px;">code-kata</a> <a href="/tags/culture/" style="font-size: 10px;">culture</a> <a href="/tags/dalvik/" style="font-size: 16px;">dalvik</a> <a href="/tags/deobfuscation/" style="font-size: 12px;">deobfuscation</a> <a href="/tags/dex-oracle/" style="font-size: 10px;">dex-oracle</a> <a href="/tags/jni/" style="font-size: 12px;">jni</a> <a href="/tags/machine-learning/" style="font-size: 14px;">machine learning</a> <a href="/tags/networking/" style="font-size: 10px;">networking</a> <a href="/tags/open-source/" style="font-size: 12px;">open source</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/realtalk/" style="font-size: 12px;">realtalk</a> <a href="/tags/research/" style="font-size: 18px;">research</a> <a href="/tags/reversing/" style="font-size: 10px;">reversing</a> <a href="/tags/security/" style="font-size: 12px;">security</a> <a href="/tags/simplify/" style="font-size: 14px;">simplify</a> <a href="/tags/smali/" style="font-size: 10px;">smali</a> <a href="/tags/smalivm/" style="font-size: 12px;">smalivm</a> <a href="/tags/tdd/" style="font-size: 10px;">tdd</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Caleb Fenton<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'calebfenton';
  
  var disqus_url = 'https://calebfenton.github.io/2017/08/23/using-markov-chains-for-android-malware-detection/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>