<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Calling JNI Functions with Java Object Arguments from the Command Line | Caleb Fenton&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="When analyzing malware or penetration testing an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s">
<meta property="og:type" content="article">
<meta property="og:title" content="Calling JNI Functions with Java Object Arguments from the Command Line">
<meta property="og:url" content="https://calebfenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/index.html">
<meta property="og:site_name" content="Caleb Fenton&#39;s Blog">
<meta property="og:description" content="When analyzing malware or penetration testing an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s">
<meta property="og:locale">
<meta property="article:published_time" content="2017-04-14T16:11:11.000Z">
<meta property="article:modified_time" content="2020-06-09T16:19:15.000Z">
<meta property="article:author" content="Caleb Fenton">
<meta property="article:tag" content="research">
<meta property="article:tag" content="android">
<meta property="article:tag" content="jni">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@CalebFenton">
  
    <link rel="alternative" href="/rss2.xml" title="Caleb Fenton&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74177443-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Caleb Fenton&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/rss2.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://CalebFenton.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-calling_jni_functions_with_java_object_arguments_from_the_command_line" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/" class="article-date">
  <time datetime="2017-04-14T16:11:11.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Calling JNI Functions with Java Object Arguments from the Command Line
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When analyzing malware or <a target="_blank" rel="noopener" href="http://i.imgur.com/hV9YDNn.gif">penetration testing</a> an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s own code against it. For example, if the malware has encrypted strings and the decryption is done by a native function, you could either spend a bunch of time <a target="_blank" rel="noopener" href="http://imgur.com/gallery/9Q1fmSI">reversing</a> the algorithm to write your own decryption routine or you could just <a target="_blank" rel="noopener" href="http://68.media.tumblr.com/f986bf831261e6935a59c18dccf73f17/tumblr_mltn4vLW8j1rn15aho1_500.gif">harness</a> the function such that you can execute it with arbitrary inputs. If the malware author completely changes their decryption, you might not have to change anything. In this post, I’ll explain how to harness a native library and execute its functions even if they require arguments from a live JVM instance.</p>
<p>In a previous post, I explained how to <a href="/2017/04/05/creating_java_vm_from_android_native_code/">create a Java VM from Android native code</a> but I didn’t give any real examples of how to use it. In this post, I’ll give a concrete example.</p>
<span id="more"></span>

<p>There are at least two approaches to harness a native function. The first is to modify the app to accept some input from you and pass that to the native function. For example, you can write an intent filter, <a href="https://calebfenton.github.io/2016/07/31/understanding_dalvik_static_fields_1_of_2/">convert it to Smali</a>, add the code to the target app, modify the manifest, run the app, and send it intents via <code>adb</code> with your arguments. Even better, you could add a small socket or web server instead of an intent filter and send <code>curl</code> requests, which doesn’t require modifying the manifest.</p>
<p>The second approach is to create a small native executable which loads the library, calls the target function, can be executed from the command line, and passes whatever arguments you give it. This makes it easier to debug since you’re just running an executable rather than an entire app.</p>
<h2 id="Target-App"><a href="#Target-App" class="headerlink" title="Target App"></a>Target App</h2><p>I created an example app so you can follow along at home. It’s called <a target="_blank" rel="noopener" href="https://github.com/CalebFenton/native-harness-target">native-harness-target</a>. To clone and build (of course replace <code>$ANDROID_*</code> vars for yourself):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/CalebFenton/native-harness-target.git</span><br><span class="line"><span class="built_in">cd</span> native-harness-target</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;ndk.dir=$ANDROID_NDK&#x27;</span> &gt; local.properties</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;sdk.dir=$ANDROID_SDK&#x27;</span> &gt;&gt; local.properties</span><br><span class="line">./gradlew build</span><br></pre></td></tr></table></figure>

<p>The APKs will be in <em>app&#x2F;build&#x2F;outputs&#x2F;apk&#x2F;</em>. For this post, I’ll be using an x86 emulator image and <em>app-universal-debug.apk</em>.</p>
<p>The app has an encrypted string and uses a native library to decrypt the string at run time. Here’s how the string decryption looks in Smali:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const/16 v3, 0x57<span class="built_in"></span></span><br><span class="line"><span class="built_in">new-array </span>v1, v3, [B<span class="built_in"></span></span><br><span class="line"><span class="built_in">fill-array-data </span>v1,<span class="keyword"> :array_2a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.local</span> v1, <span class="string">&quot;encryptedStringBytes&quot;</span>:[B<span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-static </span>&#123;&#125;, <span class="class">Lorg/cf/nativeharness/Cryptor;</span>-&gt;getInstance()<span class="class">Lorg/cf/nativeharness/Cryptor;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v0</span><br><span class="line"></span><br><span class="line"><span class="keyword">.line</span> 21</span><br><span class="line"><span class="keyword">.local</span> v0, <span class="string">&quot;c&quot;</span>:<span class="class">Lorg/cf/nativeharness/Cryptor;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># v3 contains a String made from encrypted bytes</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">new-instance </span>v3, <span class="class">Ljava/lang/String;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-direct </span>&#123;v3, v1&#125;, <span class="class">Ljava/lang/String;</span>-&gt;&lt;init&gt;([B)V</span><br><span class="line"></span><br><span class="line"><span class="comment"># Call the decryption method, move result back to v3</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">invoke-virtual </span>&#123;v0, v3&#125;, <span class="class">Lorg/cf/nativeharness/Cryptor;</span>-&gt;decryptString(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span><span class="built_in"></span></span><br><span class="line"><span class="built_in">move-result-object </span>v3</span><br></pre></td></tr></table></figure>

<h2 id="Building-the-Harness"><a href="#Building-the-Harness" class="headerlink" title="Building the Harness"></a>Building the Harness</h2><p>I started with a tool called <a target="_blank" rel="noopener" href="https://github.com/rednaga/native-shim">native-shim</a> by Tim “diff” Strazzere (a fellow <a target="_blank" rel="noopener" href="https://rednaga.io/">RedNaga</a> member!) as a foundation for the harness. What <a target="_blank" rel="noopener" href="http://vibralign.com/wp-content/uploads/footshim.jpg">shim</a> does is load a library and call its <code>JNI_OnLoad</code>. This makes debugging easy because you can just tell your debugger to start <code>shim</code> and pass the path to the target library as an argument. Set your debugger to break on library load and you can step through the <code>JNI_OnLoad</code>. Also, native-shim is great because it shows how to do almost everything you need to make harness work: load libraries (<em>.so</em> files), get references to functions, and call them.</p>
<p>First, I added code to <a href="/2017/04/05/creating_java_vm_from_android_native_code/">initialize a Java VM instance</a> and passed that instance to <code>JNI_OnLoad</code>. This makes for a more realistic JNI initialization. Without a real VM instance, the <a target="_blank" rel="noopener" href="https://cdn.meme.am/cache/instances/folder625/500x/50419625.jpg">internal state of the JNI library may be a little weird</a>. It really depends on how <code>JNI_OnLoad</code> is implemented by the particular library. It may not matter at all, but it’s common to <a target="_blank" rel="noopener" href="https://developer.android.com/training/articles/perf-jni.html#native_libraries">check the JNI version</a> from the little code I’ve seen, and to do that you need an instance of the VM.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; [+] Initializing JavaVM Instance\n&quot;</span>);</span><br><span class="line">JavaVM *vm = <span class="literal">NULL</span>;</span><br><span class="line">JNIEnv *env = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> status = init_jvm(&amp;vm, &amp;env);</span><br><span class="line"><span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot; [+] Initialization success (vm=%p, env=%p)\n&quot;</span>, vm, env);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot; [!] Initialization failure (%i)\n&quot;</span>, status);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot; [+] Calling JNI_OnLoad\n&quot;</span>);</span><br><span class="line">onLoadFunc(vm, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>Tim, just let me know if you want this in native-shim and I’ll send <a target="_blank" rel="noopener" href="https://i.imgur.com/QrfRyEU.jpg">a pull request</a>.</p>
<p>Eventually, the goal was to make the harness open a socket server, read arguments over the socket, and call the function with those arguments. This way, the decryption function just becomes a service, and a Python script could easily interface with it.</p>
<h3 id="Understand-the-Target-Function"><a href="#Understand-the-Target-Function" class="headerlink" title="Understand the Target Function"></a>Understand the Target Function</h3><p>To call a function you need the function signature and the return type. To get this, let’s look at a decompilation of  <code>org.cf.nativeharness.Cryptor</code> which declares the <code>decryptString</code> native method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cryptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Cryptor</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Cryptor <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Cryptor</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">decryptString</span><span class="params">(String encryptedString)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>From this code, you can see the method takes a <code>String</code> and returns a <code>String</code>. Seems simple. Let’s convert that to a native function method signature.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java_org_cf_nativeharness_Cryptor_decryptString(JNIEnv *env, jstring encryptedString)</span><br></pre></td></tr></table></figure>

<p>Every JNI native method needs <code>JNIEnv</code> as the first argument. This means the typedef for our function should be:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">jstring</span><span class="params">(*decryptString_t)</span><span class="params">(JNIEnv *, jstring)</span>;</span><br></pre></td></tr></table></figure>

<p>Unfortunately, if you try executing this function using the above typedef, you’ll get a cryptic error message:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">E/dalvikvm: JNI ERROR (app bug): attempt to use stale local reference 0x1</span><br><span class="line">E/dalvikvm: VM aborting</span><br><span class="line">A/libc: Fatal signal 6 (SIGABRT) at 0x00000a9a (code=-6), thread 2714 (harness)</span><br></pre></td></tr></table></figure>

<p>This confused me for a while. I thought maybe I was getting a null reference somewhere so I added lots of <code>printf</code>s to show the memory locations of all the relevant pointers. The error really sounds like there’s something wrong with one of the arguments, but all of the pointers looked good, none were null.</p>
<p>I had the idea to be extra super double sure I got the method signature right. Maybe there’s some JNI boiler plate I was forgetting? To do this, I used <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javah.html"><code>javah</code></a> which generates C header and source files that are needed to implement native methods.</p>
<p>To do this, you’ll need <a target="_blank" rel="noopener" href="https://github.com/pxb1988/dex2jar">dex2jar</a> installed and on your class path and you need to change <code>platforms/android-19</code> to point to whichever platform you have installed.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ d2j-dex2jar.sh app-universal-debug.apk</span><br><span class="line">dex2jar app-universal-debug.apk -&gt; ./app-universal-debug-dex2jar.jar</span><br><span class="line">$ javah -cp app-universal-debug-dex2jar.jar:$ANDROID_SDK/platforms/android-19/android.jar org.cf.nativeharness.Cryptor</span><br></pre></td></tr></table></figure>

<p>This creates <em>org_cf_nativeharness_Cryptor.h</em> which contains:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_org_cf_nativeharness_Cryptor_decryptString</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject, jstring)</span>;</span><br></pre></td></tr></table></figure>

<p>This has <code>jobject</code> as the second argument. <strong>WHY?</strong> What gives? If already know the answer to this, I bet you’ve spent a lot of time looking at <a target="_blank" rel="noopener" href="https://github.com/github/linguist/pull/2422">Smali</a>, specifically <code>invoke-virtual</code>. Whenever you call a virtual method (i.e. usually anything non-static), the first argument is <em>an instance of the object which implements the method</em>. In this case, the first argument should be an instance of <code>org.cf.nativeharness.Cryptor</code>.</p>
<p>Of course, you could cheat and just look at <a target="_blank" rel="noopener" href="https://github.com/CalebFenton/native-harness-target/blob/master/app/src/main/cpp/str-crypt.c"><em>str-crypt.c</em></a> to find the signature but if you’re really reverse engineering or pen-testing, you won’t have the source.</p>
<p>The <em>real</em> function typedef should have a <code>jobject</code> for the <code>Cryptor</code> instance as the first argument:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">jstring</span><span class="params">(*decryptString_t)</span><span class="params">(JNIEnv *, jobject, jstring)</span>;</span><br></pre></td></tr></table></figure>

<p>You may be wondering why the method is not static to begin with. There isn’t a good reason for it to be static, true. But in the original app which made me write this blog, the target method wasn’t static and I ran into this problem.</p>
<p>The lesson here is if you’re not sure what the signature is, try <code>javah</code> and keep in mind virtual methods take an instance for the first argument, similar to Java’s <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Method.html#invoke(java.lang.Object,%20java.lang.Object...)"><code>Method#invoke()</code></a>.</p>
<h2 id="Building-the-Socket-Server"><a href="#Building-the-Socket-Server" class="headerlink" title="Building the Socket Server"></a>Building the Socket Server</h2><p>This is the least interesting part of harness. If you don’t mind, I’m just going to skip this. You can see <a target="_blank" rel="noopener" href="https://github.com/CalebFenton/native-harness-target/blob/master/harness/server.c">the code</a> for yourself. Also, I’m just a C tourist. If you think the code is shit, I believe you. But if you want to tell me it’s shit, it must come with <a target="_blank" rel="noopener" href="https://cdn.meme.am/cache/instances/folder117/500x/22899117.jpg">a pull request</a>.</p>
<h2 id="Using-the-Harness"><a href="#Using-the-Harness" class="headerlink" title="Using the Harness"></a>Using the Harness</h2><p>Here’s an overview of the steps required to test the harness:</p>
<ol>
<li>start an emulator</li>
</ol>
<ul>
<li>push the harness to the device</li>
<li>push target native library and any dependencies to the device (in this case, there are no dependencies)</li>
<li>push the native harness target app to the device</li>
<li>start the harness</li>
<li>forward ports from the emulator to the host</li>
<li>run <a target="_blank" rel="noopener" href="https://github.com/CalebFenton/native-harness-target/blob/master/harness/decrypt_string.py"><em>decrypt_string.py</em></a> and cross your fingers</li>
</ul>
<p>To push the app and native library to the device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ adb push app/build/output/apk/app-universal-debug.apk /data/local/tmp/target-app.apk</span><br><span class="line">$ unzip app/build/outputs/apk/app-universal-debug.apk lib/x86/libstr-crypt.so</span><br><span class="line">Archive:  app/build/outputs/apk/app-universal-debug.apk</span><br><span class="line">  inflating: lib/x86/libstr-crypt.so</span><br><span class="line">$ adb push lib/x86/libstr-crypt.so /data/local/tmp</span><br><span class="line">lib/x86/libstr-crypt.so: 1 file pushed. 1.5 MB/s (5476 bytes <span class="keyword">in</span> 0.004s)</span><br></pre></td></tr></table></figure>

<p>To push harness to the device,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> harness</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> this pushes the x86 library to the device. If you really want to use another emulator image, replace <code>make install</code> with <code>adb push libs/&lt;your emulator flavor&gt;/harness /data/local/tmp</code>.</p>
<p>Now, run <code>harness</code> with the path to the target library as the first argument:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell /data/local/tmp/harness /data/local/tmp/libstr-crypt.so</span><br><span class="line">[*] Native Harness</span><br><span class="line"> [+] Loading target: [ /data/local/tmp/libstr-crypt.so ]</span><br><span class="line"> [+] Library Loaded!</span><br><span class="line"> [+] Found JNI_OnLoad, good</span><br><span class="line"> [+] Initializing JavaVM Instance</span><br><span class="line">WARNING: linker: libdvm.so has text relocations. This is wasting memory and is a security risk. Please fix.</span><br><span class="line"> [+] Initialization success (vm=0xb8e420a0, <span class="built_in">env</span>=0xb8e420e0)</span><br><span class="line"> [+] Calling JNI_OnLoad</span><br><span class="line"> [+] Found decryptString <span class="keyword">function</span>, good (0xb761f4f0)</span><br><span class="line"> [+] Finding Cryptor class</span><br><span class="line"> [+] Found Cryptor class: 0x1d2001d9</span><br><span class="line"> [+] Found Cryptor.getInstance(): 0xb27bc270</span><br><span class="line"> [+] Instantiated Cryptor class: 0x1d2001dd</span><br><span class="line"> [+] Starting socket server on port 5001</span><br></pre></td></tr></table></figure>

<p>To test that it’s all working, in another terminal run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./decrypt_string.py</span><br><span class="line">Sending encrypted string</span><br><span class="line">Decrypted string: <span class="string">&quot;Seek freedom and become captive of your desires. Seek discipline and find your liberty.&quot;</span></span><br></pre></td></tr></table></figure>

<p>Finally, bask in your own greatness if you catch the reference, nerd.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>You should be able to take the harness code and modify the target function to run whatever function you want. This won’t always work 100% reliably because programs are arbitrarily complicated and can do all kinds of weird shit.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://calebfenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/" data-id="ckzxb6f7b0001hfao8b8v5sth" class="article-share-link">Share</a>
      
        <a href="https://calebfenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jni/" rel="tag">jni</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/research/" rel="tag">research</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/05/21/how-bitcoin-improves-free-speech-and-government/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          How Bitcoin Improves Free Speech and Government
        
      </div>
    </a>
  
  
    <a href="/2017/04/05/creating_java_vm_from_android_native_code/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Creating a Java VM from Android Native Code</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/28/measuring-the-usefulness-of-multiple-models/">Measuring the Usefulness of Multiple Models</a>
          </li>
        
          <li>
            <a href="/2017/09/25/filtering-popular-code-and-effects-on-model-accuracy/">Filtering Popular Code and Effects on Model Accuracy</a>
          </li>
        
          <li>
            <a href="/2017/09/24/malware-analysts-guide-to-bitcoin/">Malware Analyst’s Guide to Bitcoin</a>
          </li>
        
          <li>
            <a href="/2017/08/23/using-markov-chains-for-android-malware-detection/">Using Markov Chains for Android Malware Detection</a>
          </li>
        
          <li>
            <a href="/2017/05/27/monitoring-https-of-a-single-app-on-osx/">Monitoring HTTPS Traffic of a Single App on OSX</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div id="twitter-feed" class="widget-wrap">
  <h3 class="widget-title">Twitter Feed</h3>
  <div class="widget">
    <a class="twitter-timeline" data-height="2000" target="_blank" rel="noopener" href="https://twitter.com/caleb_fenton">Tweets by caleb_fenton</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anti-virus/" rel="tag">anti-virus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bitcoin/" rel="tag">bitcoin</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/business/" rel="tag">business</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-kata/" rel="tag">code-kata</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/culture/" rel="tag">culture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dalvik/" rel="tag">dalvik</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deobfuscation/" rel="tag">deobfuscation</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dex-oracle/" rel="tag">dex-oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jni/" rel="tag">jni</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/machine-learning/" rel="tag">machine learning</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/networking/" rel="tag">networking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/" rel="tag">open source</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/realtalk/" rel="tag">realtalk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/research/" rel="tag">research</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reversing/" rel="tag">reversing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simplify/" rel="tag">simplify</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smali/" rel="tag">smali</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smalivm/" rel="tag">smalivm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tdd/" rel="tag">tdd</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/anti-virus/" style="font-size: 10px;">anti-virus</a> <a href="/tags/bitcoin/" style="font-size: 12px;">bitcoin</a> <a href="/tags/business/" style="font-size: 10px;">business</a> <a href="/tags/code-kata/" style="font-size: 12px;">code-kata</a> <a href="/tags/culture/" style="font-size: 10px;">culture</a> <a href="/tags/dalvik/" style="font-size: 16px;">dalvik</a> <a href="/tags/deobfuscation/" style="font-size: 12px;">deobfuscation</a> <a href="/tags/dex-oracle/" style="font-size: 10px;">dex-oracle</a> <a href="/tags/jni/" style="font-size: 12px;">jni</a> <a href="/tags/machine-learning/" style="font-size: 14px;">machine learning</a> <a href="/tags/networking/" style="font-size: 10px;">networking</a> <a href="/tags/open-source/" style="font-size: 12px;">open source</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/realtalk/" style="font-size: 12px;">realtalk</a> <a href="/tags/research/" style="font-size: 18px;">research</a> <a href="/tags/reversing/" style="font-size: 10px;">reversing</a> <a href="/tags/security/" style="font-size: 12px;">security</a> <a href="/tags/simplify/" style="font-size: 14px;">simplify</a> <a href="/tags/smali/" style="font-size: 10px;">smali</a> <a href="/tags/smalivm/" style="font-size: 12px;">smalivm</a> <a href="/tags/tdd/" style="font-size: 10px;">tdd</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Caleb Fenton<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'calebfenton';
  
  var disqus_url = 'https://calebfenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>