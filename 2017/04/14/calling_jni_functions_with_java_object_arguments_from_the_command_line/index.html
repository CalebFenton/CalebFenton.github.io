<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Calling JNI Functions with Java Object Arguments from the Command Line | Caleb Fenton&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="When analyzing malware or penetration testing an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s">
<meta name="keywords" content="android,research,jni">
<meta property="og:type" content="article">
<meta property="og:title" content="Calling JNI Functions with Java Object Arguments from the Command Line">
<meta property="og:url" content="https://CalebFenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/index.html">
<meta property="og:site_name" content="Caleb Fenton&#39;s Blog">
<meta property="og:description" content="When analyzing malware or penetration testing an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s">
<meta property="og:updated_time" content="2017-04-14T19:36:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Calling JNI Functions with Java Object Arguments from the Command Line">
<meta name="twitter:description" content="When analyzing malware or penetration testing an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s">
<meta name="twitter:creator" content="@CalebFenton">
  
    <link rel="alternative" href="/rss2.xml" title="Caleb Fenton&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-74177443-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Caleb Fenton&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Break Stuff To Make It Better</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/rss2.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://CalebFenton.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-calling_jni_functions_with_java_object_arguments_from_the_command_line" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/" class="article-date">
  <time datetime="2017-04-14T18:11:11.000Z" itemprop="datePublished">2017-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Calling JNI Functions with Java Object Arguments from the Command Line
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When analyzing malware or <a href="http://i.imgur.com/hV9YDNn.gif" target="_blank" rel="external">penetration testing</a> an app which uses a native library, it’s helpful to isolate and execute the library’s functions. This opens the door for debugging and using the malware’s own code against it. For example, if the malware has encrypted strings and the decryption is done by a native function, you could either spend a bunch of time <a href="http://imgur.com/gallery/9Q1fmSI" target="_blank" rel="external">reversing</a> the algorithm to write your own decryption routine or you could just <a href="http://68.media.tumblr.com/f986bf831261e6935a59c18dccf73f17/tumblr_mltn4vLW8j1rn15aho1_500.gif" target="_blank" rel="external">harness</a> the function such that you can execute it with arbitrary inputs. If the malware author completely changes their decryption, you might not have to change anything. In this post, I’ll explain how to harness a native library and execute its functions even if they require arguments from a live JVM instance.</p>
<p>In a previous post, I explained how to <a href="/2017/04/05/creating_java_vm_from_android_native_code/">create a Java VM from Android native code</a> but I didn’t give any real examples of how to use it. In this post, I’ll give a concrete example.<br><a id="more"></a></p>
<p>There are at least two approaches to harness a native function. The first is to modify the app to accept some input from you and pass that to the native function. For example, you can write an intent filter, <a href="https://calebfenton.github.io/2016/07/31/understanding_dalvik_static_fields_1_of_2/">convert it to Smali</a>, add the code to the target app, modify the manifest, run the app, and send it intents via <code>adb</code> with your arguments. Even better, you could add a small socket or web server instead of an intent filter and send <code>curl</code> requests, which doesn’t require modifying the manifest.</p>
<p>The second approach is to create a small native executable which loads the library, calls the target function, can be executed from the command line, and passes whatever arguments you give it. This makes it easier to debug since you’re just running an executable rather than an entire app.</p>
<h2 id="Target-App"><a href="#Target-App" class="headerlink" title="Target App"></a>Target App</h2><p>I created an example app so you can follow along at home. It’s called <a href="https://github.com/CalebFenton/native-harness-target" target="_blank" rel="external">native-harness-target</a>. To clone and build (of course replace <code>$ANDROID_*</code> vars for yourself):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/CalebFenton/native-harness-target.git</div><div class="line"><span class="built_in">cd</span> native-harness-target</div><div class="line"><span class="built_in">echo</span> <span class="string">'ndk.dir=$ANDROID_NDK'</span> &gt; local.properties</div><div class="line"><span class="built_in">echo</span> <span class="string">'sdk.dir=$ANDROID_SDK'</span> &gt;&gt; local.properties</div><div class="line">./gradlew build</div></pre></td></tr></table></figure>
<p>The APKs will be in <em>app/build/outputs/apk/</em>. For this post, I’ll be using an x86 emulator image and <em>app-universal-debug.apk</em>.</p>
<p>The app has an encrypted string and uses a native library to decrypt the string at run time. Here’s how the string decryption looks in Smali:</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">const/16 v3, 0x57<span class="built_in"></span></div><div class="line">new-array v1, v3, [B<span class="built_in"></span></div><div class="line">fill-array-data v1,<span class="keyword"> :array_2a</span></div><div class="line"></div><div class="line"><span class="keyword">.local</span> v1, <span class="string">"encryptedStringBytes"</span>:[B<span class="built_in"></span></div><div class="line">invoke-static &#123;&#125;, <span class="class">Lorg/cf/nativeharness/Cryptor;</span>-&gt;getInstance()<span class="class">Lorg/cf/nativeharness/Cryptor;</span><span class="built_in"></span></div><div class="line">move-result-object v0</div><div class="line"></div><div class="line"><span class="keyword">.line</span> 21</div><div class="line"><span class="keyword">.local</span> v0, <span class="string">"c"</span>:<span class="class">Lorg/cf/nativeharness/Cryptor;</span></div><div class="line"></div><div class="line"><span class="comment"># v3 contains a String made from encrypted bytes</span><span class="built_in"></span></div><div class="line">new-instance v3, <span class="class">Ljava/lang/String;</span><span class="built_in"></span></div><div class="line">invoke-direct &#123;v3, v1&#125;, <span class="class">Ljava/lang/String;</span>-&gt;&lt;init&gt;([B)V</div><div class="line"></div><div class="line"><span class="comment"># Call the decryption method, move result back to v3</span><span class="built_in"></span></div><div class="line">invoke-virtual &#123;v0, v3&#125;, <span class="class">Lorg/cf/nativeharness/Cryptor;</span>-&gt;decryptString(<span class="class">Ljava/lang/String;</span>)<span class="class">Ljava/lang/String;</span><span class="built_in"></span></div><div class="line">move-result-object v3</div></pre></td></tr></table></figure>
<h2 id="Building-the-Harness"><a href="#Building-the-Harness" class="headerlink" title="Building the Harness"></a>Building the Harness</h2><p>I started with a tool called <a href="https://github.com/rednaga/native-shim" target="_blank" rel="external">native-shim</a> by Tim “diff” Strazzere (a fellow <a href="https://rednaga.io/" target="_blank" rel="external">RedNaga</a> member!) as a foundation for the harness. What <a href="http://vibralign.com/wp-content/uploads/footshim.jpg" target="_blank" rel="external">shim</a> does is load a library and call its <code>JNI_OnLoad</code>. This makes debugging easy because you can just tell your debugger to start <code>shim</code> and pass the path to the target library as an argument. Set your debugger to break on library load and you can step through the <code>JNI_OnLoad</code>. Also, native-shim is great because it shows how to do almost everything you need to make harness work: load libraries (<em>.so</em> files), get references to functions, and call them.</p>
<p>First, I added code to <a href="/2017/04/05/creating_java_vm_from_android_native_code/">initialize a Java VM instance</a> and passed that instance to <code>JNI_OnLoad</code>. This makes for a more realistic JNI initialization. Without a real VM instance, the <a href="https://cdn.meme.am/cache/instances/folder625/500x/50419625.jpg" target="_blank" rel="external">internal state of the JNI library may be a little weird</a>. It really depends on how <code>JNI_OnLoad</code> is implemented by the particular library. It may not matter at all, but it’s common to <a href="https://developer.android.com/training/articles/perf-jni.html#native_libraries" target="_blank" rel="external">check the JNI version</a> from the little code I’ve seen, and to do that you need an instance of the VM.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">printf</span>(<span class="string">" [+] Initializing JavaVM Instance\n"</span>);</div><div class="line">JavaVM *vm = <span class="literal">NULL</span>;</div><div class="line">JNIEnv *env = <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">int</span> status = init_jvm(&amp;vm, &amp;env);</div><div class="line"><span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">" [+] Initialization success (vm=%p, env=%p)\n"</span>, vm, env);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">" [!] Initialization failure (%i)\n"</span>, status);</div><div class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">printf</span>(<span class="string">" [+] Calling JNI_OnLoad\n"</span>);</div><div class="line">onLoadFunc(vm, <span class="literal">NULL</span>);</div></pre></td></tr></table></figure>
<p>Tim, just let me know if you want this in native-shim and I’ll send <a href="https://cdn.meme.am/instances/500x/62024625/please-guy-please-merge-my-pull-request.jpg" target="_blank" rel="external">a pull request</a>.</p>
<p>Eventually, the goal was to make the harness open a socket server, read arguments over the socket, and call the function with those arguments. This way, the decryption function just becomes a service, and a Python script could easily interface with it.</p>
<h3 id="Understand-the-Target-Function"><a href="#Understand-the-Target-Function" class="headerlink" title="Understand the Target Function"></a>Understand the Target Function</h3><p>To call a function you need the function signature and the return type. To get this, let’s look at a decompilation of  <code>org.cf.nativeharness.Cryptor</code> which declares the <code>decryptString</code> native method.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cryptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cryptor instance = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Cryptor <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">            instance = <span class="keyword">new</span> Cryptor();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">decryptString</span><span class="params">(String encryptedString)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>From this code, you can see the method takes a <code>String</code> and returns a <code>String</code>. Seems simple. Let’s convert that to a native function method signature.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Java_org_cf_nativeharness_Cryptor_decryptString(JNIEnv *env, jstring encryptedString)</div></pre></td></tr></table></figure>
<p>Every JNI native method needs <code>JNIEnv</code> as the first argument. This means the typedef for our function should be:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">jstring</span><span class="params">(*decryptString_t)</span><span class="params">(JNIEnv *, jstring)</span></span>;</div></pre></td></tr></table></figure>
<p>Unfortunately, if you try executing this function using the above typedef, you’ll get a cryptic error message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">E/dalvikvm: JNI ERROR (app bug): attempt to use stale local reference 0x1</div><div class="line">E/dalvikvm: VM aborting</div><div class="line">A/libc: Fatal signal 6 (SIGABRT) at 0x00000a9a (code=-6), thread 2714 (harness)</div></pre></td></tr></table></figure>
<p>This confused me for a while. I thought maybe I was getting a null reference somewhere so I added lots of <code>printf</code>s to show the memory locations of all the relevant pointers. The error really sounds like there’s something wrong with one of the arguments, but all of the pointers looked good, none were null.</p>
<p>I had the idea to be extra super double sure I got the method signature right. Maybe there’s some JNI boiler plate I was forgetting? To do this, I used <a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/javah.html" target="_blank" rel="external"><code>javah</code></a> which generates C header and source files that are needed to implement native methods.</p>
<p>To do this, you’ll need <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="external">dex2jar</a> installed and on your class path and you need to change <code>platforms/android-19</code> to point to whichever platform you have installed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ d2j-dex2jar.sh app-universal-debug.apk</div><div class="line">dex2jar app-universal-debug.apk -&gt; ./app-universal-debug-dex2jar.jar</div><div class="line">$ javah -cp app-universal-debug-dex2jar.jar:$ANDROID_SDK/platforms/android-19/android.jar org.cf.nativeharness.Cryptor</div></pre></td></tr></table></figure>
<p>This creates _org_cf_nativeharness_Cryptor.h_ which contains:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_org_cf_nativeharness_Cryptor_decryptString</span></span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jstring)</span>;</div></pre></td></tr></table></figure>
<p>This has <code>jobject</code> as the second argument. <strong>WHY?</strong> What gives? If already know the answer to this, I bet you’ve spent a lot of time looking at <a href="https://github.com/github/linguist/pull/2422" target="_blank" rel="external">Smali</a>, specifically <code>invoke-virtual</code>. Whenever you call a virtual method (i.e. usually anything non-static), the first argument is <em>an instance of the object which implements the method</em>. In this case, the first argument should be an instance of <code>org.cf.nativeharness.Cryptor</code>.</p>
<p>Of course, you could cheat and just look at <a href="https://github.com/CalebFenton/native-harness-target/blob/master/app/src/main/cpp/str-crypt.c" target="_blank" rel="external"><em>str-crypt.c</em></a> to find the signature but if you’re really reverse engineering or pen-testing, you won’t have the source.</p>
<p>The <em>real</em> function typedef should have a <code>jobject</code> for the <code>Cryptor</code> instance as the first argument:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">jstring</span><span class="params">(*decryptString_t)</span><span class="params">(JNIEnv *, jobject, jstring)</span></span>;</div></pre></td></tr></table></figure>
<p>You may be wondering why the method is not static to begin with. There isn’t a good reason for it to be static, true. But in the original app which made me write this blog, the target method wasn’t static and I ran into this problem.</p>
<p>The lesson here is if you’re not sure what the signature is, try <code>javah</code> and keep in mind virtual methods take an instance for the first argument, similar to Java’s <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Method.html#invoke(java.lang.Object,%20java.lang.Object..." target="_blank" rel="external"><code>Method#invoke()</code></a>).</p>
<h2 id="Building-the-Socket-Server"><a href="#Building-the-Socket-Server" class="headerlink" title="Building the Socket Server"></a>Building the Socket Server</h2><p>This is the least interesting part of harness. If you don’t mind, I’m just going to skip this. You can see <a href="https://github.com/CalebFenton/native-harness-target/blob/master/harness/server.c" target="_blank" rel="external">the code</a> for yourself. Also, I’m just a C tourist. If you think the code is shit, I believe you. But if you want to tell me it’s shit, it must come with <a href="https://cdn.meme.am/cache/instances/folder117/500x/22899117.jpg" target="_blank" rel="external">a pull request</a>.</p>
<h2 id="Using-the-Harness"><a href="#Using-the-Harness" class="headerlink" title="Using the Harness"></a>Using the Harness</h2><p>Here’s an overview of the steps required to test the harness:</p>
<ol>
<li>start an emulator</li>
</ol>
<ul>
<li>push the harness to the device</li>
<li>push target native library and any dependencies to the device (in this case, there are no dependencies)</li>
<li>push the native harness target app to the device</li>
<li>start the harness</li>
<li>forward ports from the emulator to the host</li>
<li>run <a href="https://github.com/CalebFenton/native-harness-target/blob/master/harness/decrypt_string.py" target="_blank" rel="external">_decrypt_string.py_</a> and cross your fingers</li>
</ul>
<p>To push the app and native library to the device:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ adb push app/build/output/apk/app-universal-debug.apk /data/<span class="built_in">local</span>/tmp/target-app.apk</div><div class="line">$ unzip app/build/outputs/apk/app-universal-debug.apk lib/x86/libstr-crypt.so</div><div class="line">Archive:  app/build/outputs/apk/app-universal-debug.apk</div><div class="line">  inflating: lib/x86/libstr-crypt.so</div><div class="line">$ adb push lib/x86/libstr-crypt.so /data/<span class="built_in">local</span>/tmp</div><div class="line">lib/x86/libstr-crypt.so: 1 file pushed. 1.5 MB/s (5476 bytes <span class="keyword">in</span> 0.004s)</div></pre></td></tr></table></figure>
<p>To push harness to the device,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> harness</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p><strong>Note:</strong> this pushes the x86 library to the device. If you really want to use another emulator image, replace <code>make install</code> with <code>adb push libs/&lt;your emulator flavor&gt;/harness /data/local/tmp</code>.</p>
<p>Now, run <code>harness</code> with the path to the target library as the first argument:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ adb shell /data/<span class="built_in">local</span>/tmp/harness /data/<span class="built_in">local</span>/tmp/libstr-crypt.so</div><div class="line">[*] Native Harness</div><div class="line"> [+] Loading target: [ /data/<span class="built_in">local</span>/tmp/libstr-crypt.so ]</div><div class="line"> [+] Library Loaded!</div><div class="line"> [+] Found JNI_OnLoad, good</div><div class="line"> [+] Initializing JavaVM Instance</div><div class="line">WARNING: linker: libdvm.so has text relocations. This is wasting memory and is a security risk. Please fix.</div><div class="line"> [+] Initialization success (vm=0xb8e420a0, env=0xb8e420e0)</div><div class="line"> [+] Calling JNI_OnLoad</div><div class="line"> [+] Found decryptString <span class="keyword">function</span>, good (0xb761f4f0)</div><div class="line"> [+] Finding Cryptor class</div><div class="line"> [+] Found Cryptor class: 0x1d2001d9</div><div class="line"> [+] Found Cryptor.getInstance(): 0xb27bc270</div><div class="line"> [+] Instantiated Cryptor class: 0x1d2001dd</div><div class="line"> [+] Starting socket server on port 5001</div></pre></td></tr></table></figure>
<p>To test that it’s all working, in another terminal run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ./decrypt_string.py</div><div class="line">Sending encrypted string</div><div class="line">Decrypted string: <span class="string">"Seek freedom and become captive of your desires. Seek discipline and find your liberty."</span></div></pre></td></tr></table></figure>
<p>Finally, bask in your own greatness if you catch the reference, nerd.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>You should be able to take the harness code and modify the target function to run whatever function you want. This won’t always work 100% reliably because programs are arbitrarily complicated and can do all kinds of weird shit.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://CalebFenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/" data-id="cj822kaj2000a6qupxfctohrf" class="article-share-link">Share</a>
      
        <a href="https://CalebFenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jni/">jni</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/research/">research</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/05/21/how-bitcoin-improves-free-speech-and-government/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          How Bitcoin Improves Free Speech and Government
        
      </div>
    </a>
  
  
    <a href="/2017/04/05/creating_java_vm_from_android_native_code/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Creating a Java VM from Android Native Code</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/08/23/using-markov-chains-for-android-malware-detection/">Using Markov Chains for Android Malware Detection</a>
          </li>
        
          <li>
            <a href="/2017/05/27/monitoring-https-of-a-single-app-on-osx/">Monitoring HTTPS Traffic of a Single App on OSX</a>
          </li>
        
          <li>
            <a href="/2017/05/21/how-bitcoin-improves-free-speech-and-government/">How Bitcoin Improves Free Speech and Government</a>
          </li>
        
          <li>
            <a href="/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/">Calling JNI Functions with Java Object Arguments from the Command Line</a>
          </li>
        
          <li>
            <a href="/2017/04/05/creating_java_vm_from_android_native_code/">Creating a Java VM from Android Native Code</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div id="twitter-feed" class="widget-wrap">
  <h3 class="widget-title">Twitter Feed</h3>
  <div class="widget">
    <a class="twitter-timeline" data-height="2000" href="https://twitter.com/caleb_fenton">Tweets by caleb_fenton</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anti-virus/">anti-virus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bitcoin/">bitcoin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/business/">business</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-kata/">code-kata</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/culture/">culture</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dalvik/">dalvik</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deobfuscation/">deobfuscation</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dex-oracle/">dex-oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jni/">jni</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/networking/">networking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-source/">open source</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/realtalk/">realtalk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/research/">research</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reversing/">reversing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simplify/">simplify</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smali/">smali</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smalivm/">smalivm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tdd/">tdd</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/anti-virus/" style="font-size: 10px;">anti-virus</a> <a href="/tags/bitcoin/" style="font-size: 10px;">bitcoin</a> <a href="/tags/business/" style="font-size: 10px;">business</a> <a href="/tags/code-kata/" style="font-size: 12px;">code-kata</a> <a href="/tags/culture/" style="font-size: 10px;">culture</a> <a href="/tags/dalvik/" style="font-size: 16px;">dalvik</a> <a href="/tags/deobfuscation/" style="font-size: 12px;">deobfuscation</a> <a href="/tags/dex-oracle/" style="font-size: 10px;">dex-oracle</a> <a href="/tags/jni/" style="font-size: 12px;">jni</a> <a href="/tags/networking/" style="font-size: 10px;">networking</a> <a href="/tags/open-source/" style="font-size: 12px;">open source</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/realtalk/" style="font-size: 12px;">realtalk</a> <a href="/tags/research/" style="font-size: 18px;">research</a> <a href="/tags/reversing/" style="font-size: 10px;">reversing</a> <a href="/tags/security/" style="font-size: 12px;">security</a> <a href="/tags/simplify/" style="font-size: 14px;">simplify</a> <a href="/tags/smali/" style="font-size: 10px;">smali</a> <a href="/tags/smalivm/" style="font-size: 12px;">smalivm</a> <a href="/tags/tdd/" style="font-size: 10px;">tdd</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Caleb Fenton<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'calebfenton';
  
  var disqus_url = 'https://CalebFenton.github.io/2017/04/14/calling_jni_functions_with_java_object_arguments_from_the_command_line/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>